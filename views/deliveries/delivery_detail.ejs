<% if (typeof delivery !=='undefined' && delivery) { %>
    <div class="bg-white p-8 card">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Delivery Details for Order #<%= delivery.order ?
                delivery.order._id : 'N/A' %>
        </h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <div>
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Delivery Information</h2>
                <ul class="list-disc list-inside text-gray-700 space-y-2">
                    <li>Delivery ID: <span class="font-medium">
                            <%= delivery._id %>
                        </span></li>
                    <li>Status:
                        <span class="status-badge status-<%= delivery.status.toLowerCase().replace(' ', '-') %>">
                            <%= delivery.status %>
                        </span>
                    </li>
                    <li>Assigned To: <%= delivery.deliveryPerson ? delivery.deliveryPerson.name : 'N/A' %>
                    </li>
                    <li>Assigned On: <%= new Date(delivery.assignmentDate).toLocaleDateString() %>
                    </li>
                    <% if (delivery.deliveredAt) { %>
                        <li>Delivered On: <%= new Date(delivery.deliveredAt).toLocaleDateString() %>
                        </li>
                        <% } %>
                            <% if (delivery.notes) { %>
                                <li>Notes: <%= delivery.notes %>
                                </li>
                                <% } %>
                                    <% if (delivery.currentLocation) { %>
                                        <li>Current Location: <%= delivery.currentLocation.latitude %>, <%=
                                                    delivery.currentLocation.longitude %>
                                        </li>
                                        <% } %>
                </ul>
            </div>
            <div>
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Order Information</h2>
                <ul class="list-disc list-inside text-gray-700 space-y-2">
                    <li>Order Status: <%= delivery.order ? delivery.order.status : 'N/A' %>
                    </li>
                    <li>Order Total: $<%= delivery.order ? delivery.order.totalAmount.toFixed(2) : 'N/A' %>
                    </li>
                    <li>Customer: <%= delivery.order && delivery.order.user ? delivery.order.user.name : 'N/A' %>
                    </li>
                    <li>Shipping Address:
                        <%= delivery.order && delivery.order.shippingAddress ? delivery.order.shippingAddress.street
                            + ', ' + delivery.order.shippingAddress.city + ', ' + delivery.order.shippingAddress.zipCode
                            + ', ' + delivery.order.shippingAddress.country : 'N/A' %>
                    </li>
                </ul>
            </div>
        </div>

        <% const isDeliveryPerson=typeof user !=='undefined' && user.isDeliveryPerson && delivery.deliveryPerson &&
            delivery.deliveryPerson._id.toString()===user._id.toString(); const isAdmin=typeof user !=='undefined' &&
            user.roles.includes('Admin'); const canUpdate=(isDeliveryPerson || isAdmin) && !['delivered', 'failed'
            , 'cancelled' ].includes(delivery.status); %>

            <% if (canUpdate) { %>
                <div class="bg-gray-50 p-6 card mt-8">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Update Delivery Status</h2>
                    <form action="/api/deliveries/deliveries/<%= delivery._id %>/status?_method=PUT" method="POST">
                        <div class="mb-4">
                            <label for="status" class="block text-gray-700 font-medium mb-2">New Status</label>
                            <select id="status" name="status" class="form-input" required>
                                <option value="">-- Select Status --</option>
                                <option value="assigned" <%=delivery.status==='assigned' ? 'selected' : '' %>>Assigned
                                </option>
                                <option value="out-for-delivery" <%=delivery.status==='out-for-delivery' ? 'selected'
                                    : '' %>>Out for Delivery</option>
                                <option value="delivered" <%=delivery.status==='delivered' ? 'selected' : '' %>
                                    >Delivered</option>
                                <option value="failed" <%=delivery.status==='failed' ? 'selected' : '' %>>Failed
                                </option>
                                <option value="cancelled" <%=delivery.status==='cancelled' ? 'selected' : '' %>
                                    >Cancelled</option>
                                <!-- Add more statuses as per your model -->
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="currentLocation" class="block text-gray-700 font-medium mb-2">Current Location
                                (Optional)</label>
                            <input type="text" id="currentLocation" name="currentLocation" class="form-input"
                                placeholder="e.g., Lat: 34.05, Lon: -118.25">
                            <p class="text-sm text-gray-500 mt-1">For delivery persons, you might integrate geolocation
                                API here.</p>
                        </div>
                        <div class="mb-4">
                            <label for="notes" class="block text-gray-700 font-medium mb-2">Notes (Optional)</label>
                            <textarea id="notes" name="notes" rows="3" class="form-input"
                                placeholder="Add any relevant notes..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary px-6 py-3 text-lg">Update Status</button>
                    </form>
                </div>
                <% } else if (['delivered', 'failed' , 'cancelled' ].includes(delivery.status)) { %>
                    <div class="bg-gray-100 border border-gray-300 text-gray-700 px-4 py-3 rounded-lg relative mt-8"
                        role="alert">
                        This delivery is in a final state (<%= delivery.status %>) and cannot be updated.
                    </div>
                    <% } %>
    </div>
    <!-- Hidden input to get delivery ID for Socket.IO room joining -->
    <input type="hidden" id="currentDeliveryId" value="<%= delivery._id %>">
    <!-- Hidden input to get order ID for Socket.IO room joining (if needed for order-specific updates) -->
    <input type="hidden" id="currentOrderId" value="<%= delivery.order ? delivery.order._id : '' %>">
    <% } else { %>
        <div class="text-center text-gray-600 py-12 bg-white card">
            <h1 class="text-3xl font-bold mb-4">Delivery Not Found</h1>
            <p>The delivery record you are looking for does not exist.</p>
            <a href="/api/deliveries/deliveries" class="btn btn-primary mt-6 inline-block">Back to Deliveries</a>
        </div>
        <% } %>